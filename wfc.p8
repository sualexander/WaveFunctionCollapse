pico-8 cartridge // http://www.pico-8.com
version 36
__lua__
m = {}
adj_rules = {}
rlength = 1
freq = {}
types = {}
tally = 0

function input()
	for x=1,16 do
		m[x] = {}
		for y=1,16 do
			m[x][y] = make_tile(x,y)
		 local temp = mget(x-1,y-1)
			check_adj(temp,x,y)
			if freq[temp] == nil then
				add(freq,1)
			else
				freq[temp]+=1
			end
		end
	end
	return m
end

function check_adj(tile,x,y)
	local faces = {}
	local temp = rlength
	add(faces,{tile,mget(x-1,y-2)})
	add(faces,{tile,mget(x-1,y)})
	add(faces,{tile,mget(x-2,y-1)})
	add(faces,{tile,mget(x,y-1)})
	for f in all(faces) do
		local match = false
		for r=1,rlength-1 do
			if rlength == 1 then
				match = false
			elseif ((f[1] == adj_rules[r][1]) and
			(f[2] == adj_rules[r][2])) then
				match = true
				break
			end
		end
		if not match then
			add(adj_rules,f)
			temp+=1
		end
	rlength=temp
	end
	return
end

function make_tile(x,y)
	return {possible={},index={x,y}}
end

function innit_map()
	for n=1,count(freq) do
		add(types,n)
	end
	for x=1,16 do
		for y=1,16 do
			m[x][y].possible = types
		end
	end
	return
end

function wfc()
	innit_map()
	r=flr(rnd(256))
	local tile = m[((r-(r%16))/16)+1][(r%16)+1]
	--collapse(tile)
	propogate(tile)
	return
end

function collapse(tile)
	local total = 0
	local sum = 0
	local indices = {}
	for p in all(tile.possible) do
		total+=freq[p]
		add(indices,freq[p])
	end
	r = flr(rnd(total))
	for n in all(indices) do
		if r <= sum+n then
			for i=1,count(freq) do
				if freq[i] == n then
					for p in all(tile.possible) do
						if p != i then
							del(tile.possible,p)
						end
					end
					m[tile.index[1]][tile.index[2]] = tile
					return
				end
			end
		else
			sum+=n
		end
	end
	return
end

function propogate(tile)
	print("propogated!")
	if count(tile.possible) == 0 then
		restart()
		return
	elseif #tile.possible == 1 then
		completion()
	end
	if tile.index[1] != 1 then
		pface(tile,-1,0)
	end
	if tile.index[1] != 16 then
		pface(tile,1,0)
	end
	if tile.index[2] != 1 then
		pface(tile,0,-1)
	end
	if tile.index[2] != 16 then
		pface(tile,0,1)
	end
	return
end

function pface(tile,xn,yn)
	i = tile.index
	ntile = m[i[1]+xn][i[2]+yn]
	for p in all(ntile.possible) do
		local match = false
		for r in all(tile.possible) do
			for s in all(adj_rules) do
				if {p,r} == s then
					match = true
				end
			end
		if not match then
			print(#ntile.possible)
			del(ntile.possible,p)
			propogate(ntile)
			return
			end
		end
	end
	return
end

function entropy(tile)


	return
end

function completion()
	tally+=1
	if tally == 256 then
		print("done")
	end
	return
end

function restart()
	print("you dun goofed")
	return
end

cls()

input()
wfc()

__gfx__
0000000011111111cccccccc4444444433b333b3bbbbbbbb55555555031331300000000000000000000000000000000000000000000000000000000000000000
0000000011111111cccccccc4454444433333333bb8bbb8b55555655180000810000000000000000000000000000000000000000000000000000000000000000
0070070011111111cccccccc444444443333bb33bbbbbbbb565555551e0000e10000000000000000000000000000000000000000000000000000000000000000
0007700011111111cccccccc4444445433333333bbbbbbbb55555555100cc0014000000000000000000000000000000000000000000000000000000000000000
0007700011111111cccccccc444444443b333333bbbb8bbb555555551000000140000ccc00000000000000000000000000000000000000000000000000000000
0070070011111111cccccccc4444444433333b33bbbbbbbb555555651e7ee7e10000cc5c00000000000000000000000000000000000000000000000000000000
0000000011111111cccccccc44454444b333b333b8bbbbbb556555551e7ee7e1000cc5cc00000000000000000000000000000000000000000000000000000000
0000000011111111cccccccc444444443333333bbbbbbb8b5555555500eeee0000cc5cc000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000330000cc5cc0000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000220000c5cc00000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000022220005cc000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000220220225000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000220050000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000002002000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000440000440000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010202030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202010101010101010101020202030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303020202020202020202020203030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0603030302020202020202020303040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0603030303030302020202020304040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303040403030302020202020304040500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303040403030302020202020304040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303040403030302020203030304040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303040403060302020203030304050400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030403030302020203060304040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0403030303030302020203060303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404030303030302020303060303040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0504040404030302020303030303040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404030302020303040403030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040504030302020303040404030600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
910300000a7100f71014720197201e7302274025740287402a7502a7502a7502975027740237401e74017740107300c7200b7200a7300b7300e74013750177501a7501a750197401773015720107100a71002710
__music__
00 01424344
